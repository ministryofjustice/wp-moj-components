<?php
/**
 * Created by PhpStorm.
 * User: damienwilson
 * Date: 2019-10-10
 * Time: 14:37
 */

namespace MOJComponents\Security;

use MOJComponents\Security\VulnerabilityDB as VulnerabilityDB;

class VulnerabilityDBSettings extends VulnerabilityDB
{
    public $helper;

    public function __construct()
    {
        global $mojHelper;
        $this->helper = $mojHelper;
    }

    public function settings()
    {
        $this->helper->initSettings($this);
    }

    public function settingsFields($section)
    {
        add_settings_field(
            'vulndb_token',
            __('API Key', 'wp-moj-components'),
            [$this, 'vulndbServiceTokenCB'],
            'mojComponentSettings',
            $section
        );

        add_settings_field(
            'to_email',
            __('Notification email', 'wp-moj-components'),
            [$this, 'notificationEmailAddress'],
            'mojComponentSettings',
            $section
        );

        add_settings_field(
            'force_collect',
            __('Force check?', 'wp-moj-components'),
            [$this, 'forceDataCollect'],
            'mojComponentSettings',
            $section
        );
    }

    public function vulndbServiceTokenCB()
    {
        $options = get_option('moj_component_settings');

        $vulndbServiceToken = $options['vulndb_token'] ?? '';

        ?>
        <input type='text' name='moj_component_settings[vulndb_token]'
               value='<?php echo $vulndbServiceToken; ?>' class="moj-component-input">
        <?php

        return null;
    }

    public function notificationEmailAddress()
    {
        $options = get_option('moj_component_settings');

        $toEmailAddress = $options['to_email'] ?? '';

        ?>
        <input type='text' name='moj_component_settings[to_email]'
               value='<?php echo $toEmailAddress; ?>' class="moj-component-input">
        <?php

        return null;
    }

    public function forceDataCollect()
    {
        $options = get_option('moj_component_settings');

        ?>
        <input type='checkbox' name='moj_component_settings[force_collect]'
               value='yes' <?= checked('yes', $options['force_collect'] ?? '') ?> class="moj-component-input-checkbox">
        <?php

        return null;
    }

    public function settingsSectionCB()
    {
        echo __(
            'Our WP Vulnerability service runs quietly in the background. To activate the service you will need an API key to interact with the <a href="https://wpvulndb.com" target="_blank">Vulnerability Database</a> servers. You may enter this below.',
            'wp-moj-components'
        );
    }
}
